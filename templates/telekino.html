{% extends "base.html" %}

{% block title %}Telekino - Tombola Analytics{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-dice-5-fill text-primary"></i> Telekino
    </h2>
    <!-- Scraping deshabilitado - usar CLI: python main.py telekino scrape -->
</div>

<!-- Date Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-6">
                <label for="fechaFiltro" class="form-label">
                    <i class="bi bi-calendar-date"></i> Filtrar hasta fecha (Backtesting)
                </label>
                <input type="date" class="form-control" id="fechaFiltro">
            </div>
            <div class="col-md-3">
                <button class="btn btn-success w-100" id="loadStatsBtn">
                    <i class="bi bi-graph-up"></i> Cargar Stats
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-secondary w-100" id="clearFilterBtn">
                    <i class="bi bi-x-circle"></i> Limpiar Filtro
                </button>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <a href="/api/telekino/download" class="btn btn-primary w-100" download>
                    <i class="bi bi-download"></i> Descargar Todos los Resultados (CSV)
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando estad√≠sticas...</p>
</div>

<!-- Check Combination Section -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-search"></i> Verificar Jugada Hist√≥rica
    </div>
    <div class="card-body">
        <p class="text-muted small">Ingresa los 15 n√∫meros (1-25) para verificar si esta combinaci√≥n ha salido alguna
            vez.</p>
        <div class="row g-2 mb-3">
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
            <div class="col-3 col-md-2"><input type="number" class="form-control text-center check-num" min="1" max="25"
                    placeholder="00"></div>
        </div>
        <button class="btn btn-primary w-100" id="checkCombinationBtn">
            Verificar Combinaci√≥n
        </button>
        <div id="checkResult" class="mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Stats Container -->
<div id="statsContainer" style="display: none;">
    <!-- Info Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h5 class="text-muted">Sorteos Cargados</h5>
                    <h2 id="sorteosCount" class="text-primary">-</h2>
                </div>
                <div class="col-md-4">
                    <h5 class="text-muted">Filtro Activo</h5>
                    <h6 id="filtroInfo" class="text-success">-</h6>
                </div>
                <div class="col-md-4">
                    <h5 class="text-muted">Cach√©</h5>
                    <span id="cacheInfo" class="badge bg-info">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-fire"></i> Top 10 - N√∫meros Calientes
                </div>
                <div class="card-body">
                    <canvas id="calientesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-snow"></i> Top 10 - N√∫meros Fr√≠os
                </div>
                <div class="card-body">
                    <canvas id="friosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-hourglass-split"></i> Top 10 - Omisi√≥n
                </div>
                <div class="card-body">
                    <canvas id="omisionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-clock-history"></i> Top 10 - Demora M√°xima Hist√≥rica
                </div>
                <div class="card-body">
                    <canvas id="demoraChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Heatmap Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-grid-3x3-gap-fill"></i> Mapa de Calor - Frecuencias
                </div>
                <div class="card-body text-center">
                    <img id="heatmapImg" src="/api/telekino/heatmap" alt="Mapa de calor Telekino" class="img-fluid"
                        style="max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>

    <!-- Sorteos Table Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-list-ol"></i> Hist√≥rico de Sorteos
                </div>
                <div class="card-body">
                    <!-- Filtro -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="sorteosDateFilter" class="form-label">Filtrar por fecha</label>
                            <input type="date" class="form-control" id="sorteosDateFilter">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" id="filterSorteosBtn">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-secondary w-100" id="clearSorteosFilterBtn">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">Sorteo</th>
                                    <th style="width: 15%;">Fecha</th>
                                    <th>N√∫meros (15 bolillas)</th>
                                </tr>
                            </thead>
                            <tbody id="sorteosTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <nav>
                        <ul class="pagination justify-content-center" id="sorteosPagination">
                            <!-- Populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Messages -->
<div id="alertContainer"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    let charts = {};

    // Load stats and sorteos on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadStats();
        loadSorteos();
    });

    // Scraping deshabilitado - usar CLI

    // Load stats button
    document.getElementById('loadStatsBtn').addEventListener('click', function () {
        loadStats();
    });

    // Clear filter button
    document.getElementById('clearFilterBtn').addEventListener('click', function () {
        document.getElementById('fechaFiltro').value = '';
        loadStats();
    });

    async function loadStats() {
        const fecha = document.getElementById('fechaFiltro').value;
        const url = fecha ? `/api/telekino/stats?fecha=${fecha}` : '/api/telekino/stats';

        document.getElementById('loading').style.display = 'block';
        document.getElementById('statsContainer').style.display = 'none';

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                displayStats(result.data, result.cached, fecha);
            } else {
                showAlert('danger', 'Error: ' + result.error);
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function displayStats(stats, cached, fecha) {
        // Update info
        document.getElementById('sorteosCount').textContent = stats.sorteos_count;
        document.getElementById('filtroInfo').textContent = fecha || 'Sin filtro';
        document.getElementById('cacheInfo').textContent = cached ? 'üì¶ Cach√©' : 'üîÑ Calculado';
        document.getElementById('cacheInfo').className = cached ? 'badge bg-info' : 'badge bg-success';

        // Update heatmap with fecha parameter
        const heatmapUrl = fecha ? `/api/telekino/heatmap?fecha=${fecha}` : '/api/telekino/heatmap';
        const separator = heatmapUrl.includes('?') ? '&' : '?';
        document.getElementById('heatmapImg').src = heatmapUrl + separator + 't=' + new Date().getTime();

        // Destroy old charts
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        // Prepare data
        const frecuencias = Object.entries(stats.frecuencias).map(([num, count]) => ({ num: parseInt(num), count }));
        const top10Hot = frecuencias.sort((a, b) => b.count - a.count).slice(0, 10);
        const top10Cold = frecuencias.sort((a, b) => a.count - b.count).slice(0, 10);

        const omision = Object.entries(stats.omision)
            .filter(([num, count]) => count > 0)
            .map(([num, count]) => ({ num: parseInt(num), count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);

        const demora = Object.entries(stats.demora_maxima)
            .map(([num, count]) => ({ num: parseInt(num), count }))
            .sort((a, b) => b.count - a.count)
            .filter(d => d.count > 0)
            .slice(0, 10);

        // Create charts
        charts.calientes = createBarChart('calientesChart',
            top10Hot.map(d => d.num),
            top10Hot.map(d => d.count),
            'Apariciones',
            'rgba(220, 53, 69, 0.7)'
        );

        charts.frios = createBarChart('friosChart',
            top10Cold.map(d => d.num),
            top10Cold.map(d => d.count),
            'Apariciones',
            'rgba(13, 202, 240, 0.7)'
        );

        charts.omision = createBarChart('omisionChart',
            omision.map(d => d.num),
            omision.map(d => d.count),
            'Sorteos sin aparecer',
            'rgba(255, 193, 7, 0.7)'
        );

        if (demora.length > 0) {
            charts.demora = createBarChart('demoraChart',
                demora.map(d => d.num),
                demora.map(d => d.count),
                'Sorteos consecutivos',
                'rgba(214, 51, 132, 0.7)'
            );
        }

        document.getElementById('statsContainer').style.display = 'block';
    }

    function createBarChart(canvasId, labels, data, label, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => l.toString().padStart(2, '0')),
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: color,
                    borderColor: color.replace('0.7', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function showAlert(type, message) {
        const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
        document.getElementById('alertContainer').innerHTML = alertHtml;
        setTimeout(() => {
            document.getElementById('alertContainer').innerHTML = '';
        }, 5000);
    }

    // ==================== SORTEOS TABLE ====================
    let currentSorteosPage = 1;
    let currentSorteosFilter = null;


    // Filter button
    document.getElementById('filterSorteosBtn').addEventListener('click', function () {
        const fecha = document.getElementById('sorteosDateFilter').value;
        if (fecha) {
            currentSorteosFilter = fecha;
            loadSorteos();
        } else {
            showAlert('warning', 'Por favor selecciona una fecha');
        }
    });

    // Clear filter button
    document.getElementById('clearSorteosFilterBtn').addEventListener('click', function () {
        document.getElementById('sorteosDateFilter').value = '';
        currentSorteosFilter = null;
        currentSorteosPage = 1;
        loadSorteos();
    });

    async function loadSorteos(page = null) {
        // If page is specified, use it. If filtering, let API calculate page
        let url = '/api/telekino/sorteos';
        const params = new URLSearchParams();

        if (page !== null) {
            params.append('page', page);
            currentSorteosPage = page;
        } else if (currentSorteosFilter) {
            params.append('fecha', currentSorteosFilter);
        } else if (currentSorteosPage > 1) {
            params.append('page', currentSorteosPage);
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                currentSorteosPage = result.pagination.page;
                displaySorteos(result.sorteos, result.pagination, result.filtered_sorteo_index);
            } else {
                showAlert('danger', 'Error al cargar sorteos: ' + result.error);
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    }

    function displaySorteos(sorteos, pagination, filteredIndex) {
        const tbody = document.getElementById('sorteosTableBody');
        tbody.innerHTML = '';

        if (sorteos.length === 0) {
            const row = tbody.insertRow();
            row.innerHTML = '<td colspan="3" class="text-center">No hay sorteos disponibles</td>';
            return;
        }

        sorteos.forEach((sorteo, index) => {
            const row = tbody.insertRow();
            const isFiltered = filteredIndex !== null && index === filteredIndex;

            if (isFiltered) {
                row.classList.add('table-warning'); // Highlight filtered row
            }

            // Sorteo #
            const sorteoCell = row.insertCell(0);
            sorteoCell.textContent = sorteo.sorteo;
            if (isFiltered) {
                sorteoCell.innerHTML += ' <i class="bi bi-arrow-left-circle-fill text-primary"></i>';
            }

            // Fecha
            row.insertCell(1).textContent = sorteo.fecha;

            // N√∫meros (con bolillas coloridas)
            const numerosCell = row.insertCell(2);
            sorteo.numeros.forEach(num => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1 mb-1';
                badge.style.fontSize = '0.9rem';
                badge.style.minWidth = '32px';
                badge.textContent = num.toString().padStart(2, '0');
                numerosCell.appendChild(badge);
            });
        });

        // Update pagination
        updateSorteosPagination(pagination);
    }

    function updateSorteosPagination(pagination) {
        const paginationEl = document.getElementById('sorteosPagination');
        paginationEl.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${!pagination.has_prev ? 'disabled' : ''}`;
        prevLi.innerHTML = '<a class="page-link" href="#"><i class="bi bi-chevron-left"></i> Anterior</a>';
        if (pagination.has_prev) {
            prevLi.querySelector('a').onclick = (e) => {
                e.preventDefault();
                loadSorteos(pagination.page - 1);
            };
        }
        paginationEl.appendChild(prevLi);

        // Page info
        const infoLi = document.createElement('li');
        infoLi.className = 'page-item disabled';
        infoLi.innerHTML = `<span class="page-link">P√°gina ${pagination.page} de ${pagination.total_pages} (${pagination.total} sorteos)</span>`;
        paginationEl.appendChild(infoLi);

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
        nextLi.innerHTML = '<a class="page-link" href="#">Siguiente <i class="bi bi-chevron-right"></i></a>';
        if (pagination.has_next) {
            nextLi.querySelector('a').onclick = (e) => {
                e.preventDefault();
                loadSorteos(pagination.page + 1);
            };
        }
        paginationEl.appendChild(nextLi);
    }
    // ==================== CHECK COMBINATION ====================
    document.getElementById('checkCombinationBtn').addEventListener('click', async function () {
        const inputs = document.querySelectorAll('.check-num');
        const numeros = Array.from(inputs).map(input => parseInt(input.value)).filter(n => !isNaN(n));

        if (numeros.length !== 15) {
            showAlert('warning', `Se requieren 15 n√∫meros. Encontrados: ${numeros.length}`);
            return;
        }

        // Validation: Range 1-25 and Duplicates
        const invalidRange = numeros.some(n => n < 1 || n > 25);
        if (invalidRange) {
            showAlert('warning', 'Los n√∫meros deben estar entre 1 y 25.');
            return;
        }

        const uniqueNumeros = new Set(numeros);
        if (uniqueNumeros.size !== 15) {
            showAlert('warning', 'No puede haber n√∫meros repetidos.');
            return;
        }

        const resultDiv = document.getElementById('checkResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Verificando...';

        try {
            const response = await fetch('/api/telekino/check-combination', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numeros: numeros })
            });
            const result = await response.json();

            if (result.success) {
                if (result.found) {
                    let html = `<div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ¬°Combinaci√≥n encontrada!</strong><br>
                        Esta jugada ha salido ${result.occurrences.length} veces:
                        <ul class="mb-0 mt-2">`;

                    result.occurrences.forEach(occ => {
                        html += `<li>${occ.fecha} (Sorteo ${occ.sorteo})</li>`;
                    });

                    html += `</ul></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-success">
                        <strong>‚úÖ ¬°Combinaci√≥n √∫nica!</strong><br>
                        Esta combinaci√≥n nunca ha salido en la historia registrada.
                    </div>`;
                }
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error de conexi√≥n: ${error.message}</div>`;
        }
    });
</script>
{% endblock %}